name: DDL Syntax Check

on:
  push: 
    paths:
      - '**/sql/**'
  pull_request: 
    paths:
      - '**/sql/**'

jobs:
  ddl-syntax-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ë³€ê²½ëœ íŒŒì¼ ê°ì§€ìš©)
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install SQLFluff
        run: |
          pip install sqlfluff
          sqlfluff --version
      
      - name: Find changed SQL files
        id: changed-files
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PRì˜ ê²½ìš° ë² ì´ìŠ¤ ë¸Œëœì¹˜ì™€ ë¹„êµ
            changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep '\.sql$' || echo "")
          else
            # Pushì˜ ê²½ìš° ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµ
            if [[ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]]; then
              # ì²« ë²ˆì§¸ í‘¸ì‹œì¸ ê²½ìš° ëª¨ë“  SQL íŒŒì¼ ê²€ì‚¬
              changed_files=$(find . -name "*.sql" -path "*/migration*" | tr '\n' ' ')
            else
              changed_files=$(git diff --name-only ${{ github.event.before }}..${{ github.event.after }} | grep '\.sql$' || echo "")
            fi
          fi
          
          echo "changed_files=$changed_files" >> $GITHUB_OUTPUT
          
          if [ -z "$changed_files" ]; then
            echo "âœ… No SQL files changed"
            echo "has_sql_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“‹ Changed SQL files:"
            echo "$changed_files"
            echo "has_sql_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: SQL Syntax Check
        if: steps.changed-files.outputs.has_sql_changes == 'true'
        run: |
          changed_files="${{ steps.changed-files.outputs.changed_files }}"
          exit_code=0
          
          echo "ğŸ” Starting SQL syntax validation..."
          echo ""
          
          for file in $changed_files; do
            if [ ! -f "$file" ]; then
              echo "âš ï¸  File not found (possibly deleted): $file"
              continue
            fi
            
            echo "ğŸ“„ Checking: $file"
            
            # SQLFluffë¡œ ë¬¸ë²• ê²€ì‚¬ë§Œ ìˆ˜í–‰ (parse ëª…ë ¹ì–´ ì‚¬ìš©)
            if sqlfluff parse --dialect "$file"; then
              echo "  âœ… Syntax valid"
            else
              echo "  âŒ Syntax error detected"
              exit_code=1
            fi
            
            echo ""
          done
          
          if [ $exit_code -eq 0 ]; then
            echo "ğŸ‰ All SQL files passed syntax validation!"
          else
            echo "ğŸ’¥ SQL syntax errors found. Please fix the issues above."
            exit 1
          fi