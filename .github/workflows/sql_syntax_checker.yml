name: DDL Syntax Check

on:
  push: 
    paths:
      - './sql/*.sql'
  pull_request: 
    paths:
      - './sql/*.sql'
  workflow_dispatch:

jobs:
  ddl-syntax-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ë³€ê²½ëœ íŒŒì¼ ê°ì§€ìš©)
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install SQLFluff
        run: |
          pip install sqlfluff
          sqlfluff --version
      
      - name: Find changed SQL files
        id: changed-files
        run: |
          echo "changed_files=$(git diff --name-only ${{ github.event.before }}..${{ github.event.after }} | grep '\.sql$' || echo "")" >> $GITHUB_OUTPUT
          
          if [ -z "$changed_files" ]; then
            echo "âœ… No SQL files changed"
            echo "has_sql_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“‹ Changed SQL files:"
            echo "$changed_files"
            echo "has_sql_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: SQL Syntax Check
        if: steps.changed-files.outputs.has_sql_changes == 'true'
        run: |
          changed_files="${{ steps.changed-files.outputs.changed_files }}"
          exit_code=0
          
          echo "ğŸ” Starting SQL syntax validation..."
          echo ""
          
          for file in $changed_files; do
            if [ ! -f "$file" ]; then
              echo "âš ï¸  File not found (possibly deleted): $file"
              continue
            fi
            
            echo "ğŸ“„ Checking: $file"
            
            # SQLFluffë¡œ ë¬¸ë²• ê²€ì‚¬ë§Œ ìˆ˜í–‰ (parse ëª…ë ¹ì–´ ì‚¬ìš©)
            if sqlfluff parse --dialect mysql "$file"; then
              echo "  âœ… Syntax valid"
            else
              echo "  âŒ Syntax error detected"
              exit_code=1
            fi
            
            echo ""
          done
          
          if [ $exit_code -eq 0 ]; then
            echo "ğŸ‰ All SQL files passed syntax validation!"
          else
            echo "ğŸ’¥ SQL syntax errors found. Please fix the issues above."
            exit 1
          fi